<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FrontendController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CinemaSeatBooking</a> &gt; <a href="index.source.html" class="el_package">com.cinema_seat_booking.controller</a> &gt; <span class="el_source">FrontendController.java</span></div><h1>FrontendController.java</h1><pre class="source lang-java linenums">package com.cinema_seat_booking.controller;

import com.cinema_seat_booking.model.Reservation;
import com.cinema_seat_booking.model.Role;
import com.cinema_seat_booking.model.User;
import com.cinema_seat_booking.repository.MovieRepository;
import com.cinema_seat_booking.repository.UserRepository;
import com.cinema_seat_booking.service.ReservationService;
import com.cinema_seat_booking.service.RoomService;
import com.cinema_seat_booking.service.ScreeningService;
import com.cinema_seat_booking.service.UserService;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.server.ResponseStatusException;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

@Controller
<span class="nc" id="L31">public class FrontendController {</span>

    @Autowired
    private RoomService roomService;
    @Autowired
    private ScreeningService screeningService;
    @Autowired
    private MovieRepository movieRepository;
    @Autowired
    private UserService userService;
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private ReservationService reservationService;

    @GetMapping(&quot;/&quot;)
    public String showLoginPage() {
<span class="nc" id="L48">        return &quot;login&quot;; // ← muestra login.html correctamente</span>
    }

    private String getUserRole() {
<span class="nc" id="L52">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L53" title="All 6 branches missed.">        if (auth != null &amp;&amp; auth.isAuthenticated() &amp;&amp; !(auth instanceof AnonymousAuthenticationToken)) {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            for (GrantedAuthority authority : auth.getAuthorities()) {</span>
<span class="nc" id="L55">                return authority.getAuthority();</span>
            }
        }
<span class="nc" id="L58">        return null;</span>
    }

    @GetMapping(&quot;/register&quot;)
    public String showRegisterPage() {
<span class="nc" id="L63">        return &quot;register&quot;; // register.html</span>
    }
    /*
     * @GetMapping(&quot;/home&quot;)
     * public String showHomePage(HttpSession session, Model model) {
     * Object userObj = session.getAttribute(&quot;user&quot;);
     * if (userObj == null) {
     * return &quot;redirect:/&quot;;
     * }
     * 
     * String role = getUserRole(session);
     * if (&quot;ADMIN&quot;.equals(role)) {
     * return &quot;redirect:/admin-dashboard&quot;;
     * }
     * 
     * model.addAttribute(&quot;movies&quot;, movieRepository.findAll());
     * return &quot;index&quot;; // Para CLIENT
     * }
     */
    /*
     * @PostMapping(&quot;/do-login&quot;)
     * public String fakeLoginRedirect(HttpSession session, HttpServletRequest
     * request) {
     * String username = request.getParameter(&quot;username&quot;);
     * 
     * com.cinema_seat_booking.model.User user = new
     * com.cinema_seat_booking.model.User();
     * user.setUsername(username);
     * user.setRole(com.cinema_seat_booking.model.Role.CLIENT);
     * 
     * session.setAttribute(&quot;user&quot;, user);
     * return &quot;redirect:/home&quot;;
     * }
     */

    @PostMapping(&quot;/do-login&quot;)
    public String login(@RequestParam String username,
            @RequestParam String password,
            HttpSession session,
            Model model) {

<span class="nc" id="L104">        User user = userService.authenticate(username, password);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L107">            model.addAttribute(&quot;error&quot;, &quot;Invalid username or password&quot;);</span>
<span class="nc" id="L108">            return &quot;login&quot;;</span>
        }

<span class="nc" id="L111">        session.setAttribute(&quot;user&quot;, user);</span>

<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (user.getRole() == Role.ADMIN) {</span>
<span class="nc" id="L114">            return &quot;redirect:/admin-dashboard&quot;;</span>
        } else {
<span class="nc" id="L116">            return &quot;redirect:/home&quot;;</span>
        }
    }

    @GetMapping(&quot;/logout&quot;)
    public String logout(HttpSession session) {
<span class="nc" id="L122">        session.invalidate(); // Cierra la sesión del usuario</span>
<span class="nc" id="L123">        return &quot;redirect:/&quot;; // Redirige a la página de login o home</span>
    }

    /*
     * @GetMapping(&quot;/home&quot;)
     * public String showHomePage(HttpSession session, Model model) {
     * // cargar películas
     * return &quot;index&quot;; // index.html
     * }
     */

    @GetMapping(&quot;/home&quot;)
    public String showHomePage(HttpSession session, Model model) {
<span class="nc" id="L136">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L138">            return &quot;redirect:/&quot;;</span>
        }

<span class="nc" id="L141">        model.addAttribute(&quot;movies&quot;, movieRepository.findAll()); // ← Carga las pelis</span>
<span class="nc" id="L142">        return &quot;index&quot;; // index.html</span>
    }

    @GetMapping(&quot;/admin-dashboard&quot;)
    public String showAdminDashboard(HttpSession session, Model model) {
<span class="nc" id="L147">        return &quot;admin-dashboard&quot;; // admin-dashboard.html</span>
    }

    @GetMapping(&quot;/myreservations&quot;)
    public String showMyReservationsPage(HttpSession session, Model model) {
<span class="nc" id="L152">        User user = (User) session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L154">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L156">        model.addAttribute(&quot;reservations&quot;, reservationService.getAllReservationsOfUser(user.getUsername()));</span>
<span class="nc" id="L157">        return &quot;myreservations&quot;; // myreservations.html</span>
    }

    @GetMapping(&quot;/payments/{reservationId}&quot;)
    public String showCheckoutPage(@PathVariable Long reservationId, HttpSession session, Model model) {
<span class="nc" id="L162">        User user = (User) session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L164">            return &quot;redirect:/&quot;;</span>
        }

<span class="nc" id="L167">        Reservation reservation = reservationService.getReservationById(reservationId);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (reservation == null) {</span>
<span class="nc" id="L169">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Reservation not found&quot;);</span>
        }

<span class="nc" id="L172">        model.addAttribute(&quot;reservation&quot;, reservation);</span>
<span class="nc" id="L173">        model.addAttribute(&quot;user&quot;, user);</span>
<span class="nc" id="L174">        return &quot;pay-reservation&quot;; // pay-reservation.html</span>
    }

    @GetMapping(&quot;/about&quot;)
    public String showAboutPage() {
<span class="nc" id="L179">        return &quot;about-us&quot;; // about-us.html</span>
    }

    @GetMapping(&quot;/404-lt&quot;)
    public String show404ltPage() {
<span class="nc" id="L184">        return &quot;404-lt&quot;; // about-us.html</span>
    }

    @GetMapping(&quot;/articles&quot;)
    public String showArticlesPage() {
<span class="nc" id="L189">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L190" title="All 6 branches missed.">        if (auth == null || !auth.isAuthenticated() || auth instanceof AnonymousAuthenticationToken) {</span>
<span class="nc" id="L191">            String username = auth.getName(); // nombre de usuario</span>
        }
<span class="nc" id="L193">        return &quot;articles&quot;;</span>
    }

    @GetMapping(&quot;/article&quot;)
    public String showArticlePage(HttpSession session) {
<span class="nc" id="L198">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L200">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L202">        return &quot;article&quot;; // article.html</span>
    }

    @GetMapping(&quot;/contact&quot;)
    public String showContactPage(HttpSession session) {
<span class="nc" id="L207">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L209">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L211">        return &quot;contact-us&quot;; // contact-us.html</span>
    }

    @GetMapping(&quot;/rooms&quot;)
    public String showRoomsPage(HttpSession session, Model model) {
<span class="nc" id="L216">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L218">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L220">        model.addAttribute(&quot;rooms&quot;, roomService.getAllRooms());</span>
<span class="nc" id="L221">        return &quot;rooms&quot;; // rooms.html</span>
    }

    @GetMapping(&quot;/rooms/{id}&quot;)
    public String showRoomDetails(@PathVariable Long id, HttpSession session, Model model) {
<span class="nc" id="L226">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L228">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L230">        model.addAttribute(&quot;room&quot;, roomService.getRoomById(id)</span>
<span class="nc" id="L231">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Room not found with ID: &quot; + id)));</span>
<span class="nc" id="L232">        return &quot;room&quot;; // room.html</span>
    }

    @GetMapping(&quot;/screenings&quot;)
    public String showScreeningsPage(HttpSession session, Model model) {
<span class="nc" id="L237">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L239">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L241">        model.addAttribute(&quot;screenings&quot;, screeningService.getAllScreenings());</span>
<span class="nc" id="L242">        return &quot;screening&quot;;</span>
    }

    @GetMapping(&quot;/screenings/{id}&quot;)
    public String showScreeningDetails(@PathVariable Long id, HttpSession session, Model model) {
<span class="nc" id="L247">        Object user = session.getAttribute(&quot;user&quot;);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L249">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L251">        model.addAttribute(&quot;screening&quot;, screeningService.getScreeningById(id)</span>
<span class="nc" id="L252">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Screening not found with ID: &quot; + id)));</span>
<span class="nc" id="L253">        return &quot;reservation&quot;; // reservation.html</span>
    }
    // lithuanian

    @GetMapping(&quot;/register-lt&quot;)
    public String showLTRegisterPage() {
<span class="nc" id="L259">        return &quot;register-lt&quot;; // register.html</span>
    }

    @GetMapping({ &quot;/lt&quot;, &quot;/home-lt&quot; })
    public String showLTHomePage(Model model) {
<span class="nc" id="L264">        model.addAttribute(&quot;movies&quot;, movieRepository.findAll());</span>
<span class="nc" id="L265">        return &quot;index-lt&quot;; // index.html</span>
    }

    @GetMapping(&quot;/about-lt&quot;)
    public String showLTAboutPage() {
<span class="nc" id="L270">        return &quot;about-us-lt&quot;; // about-us.html</span>
    }

    @GetMapping(&quot;/articles-lt&quot;)
    public String showLTArticlesPage() {
<span class="nc" id="L275">        return &quot;articles-lt&quot;; // articles.html</span>
    }

    @GetMapping(&quot;/article-lt&quot;)
    public String showLTArticlePage() {
<span class="nc" id="L280">        return &quot;article-lt&quot;; // article.html</span>
    }

    @GetMapping(&quot;/contact-lt&quot;)
    public String showLTContactPage() {
<span class="nc" id="L285">        return &quot;contact-us-lt&quot;; // contact-us.html</span>
    }

    @GetMapping(&quot;/rooms-lt&quot;)
    public String showLTRoomsPage(Model model) {
<span class="nc" id="L290">        model.addAttribute(&quot;rooms&quot;, roomService.getAllRooms());</span>
<span class="nc" id="L291">        return &quot;rooms-lt&quot;; // rooms.html</span>
    }

    @GetMapping(&quot;/screenings-lt&quot;)
    public String showLTScreeningsPage(Model model) {
<span class="nc" id="L296">        model.addAttribute(&quot;screenings&quot;, screeningService.getAllScreenings());</span>
<span class="nc" id="L297">        return &quot;screening-lt&quot;;</span>
    }

    @GetMapping(&quot;/screenings-lt/{id}&quot;)
    public String showLTScreeningDetails(@PathVariable Long id, Model model) {
        // Obtén el screening usando el ID
<span class="nc" id="L303">        model.addAttribute(&quot;screening&quot;, screeningService.getScreeningById(id)</span>
<span class="nc" id="L304">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Screening not found with ID: &quot; + id)));</span>
<span class="nc" id="L305">        return &quot;reservation-lt&quot;; // reservation.html</span>
    }

    @PostMapping(&quot;/do-register&quot;)
    public String registerUser(@RequestParam String username,
            @RequestParam String email,
            @RequestParam String password,
            HttpSession session,
            Model model) {

        // Verifica si ya existe el username
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (userRepository.findByUsername(username) != null) {</span>
<span class="nc" id="L317">            model.addAttribute(&quot;error&quot;, &quot;Username already exists. Try another.&quot;);</span>
<span class="nc" id="L318">            return &quot;register&quot;; // Vuelve al formulario con mensaje de error</span>
        }

<span class="nc" id="L321">        User user = new User();</span>
<span class="nc" id="L322">        user.setUsername(username);</span>
<span class="nc" id="L323">        user.setEmail(email);</span>
<span class="nc" id="L324">        user.setPassword(password);</span>

<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (email.toLowerCase().contains(&quot;admin&quot;)) {</span>
<span class="nc" id="L327">            user.setRole(Role.ADMIN);</span>
        } else {
<span class="nc" id="L329">            user.setRole(Role.CLIENT);</span>
        }

<span class="nc" id="L332">        userRepository.save(user);</span>
<span class="nc" id="L333">        session.setAttribute(&quot;user&quot;, user);</span>

<span class="nc bnc" id="L335" title="All 2 branches missed.">        return user.getRole() == Role.ADMIN ? &quot;redirect:/admin-dashboard&quot; : &quot;redirect:/home&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>